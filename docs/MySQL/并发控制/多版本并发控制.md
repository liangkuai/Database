# 多版本并发控制

Multi-Version Concurrency Control，MVCC

多版本并发控制是 MySQL 的 InnoDB 存储引擎实现隔离级别的一种具体方式，
- 用于实现提交读和可重复读这两种隔离级别；
- 而未提交读隔离级别总是读取最新的数据行，无需使用 MVCC；
- 可串行化隔离级别需要对所有读取的行都加锁，单纯使用 MVCC 无法实现。

### 基础概念

#### 版本号
- 系统版本号：是一个递增的数字，每开始一个新的事务，系统版本号就会自动递增。
- 事务版本号：事务开始时的系统版本号。

#### 隐藏的列
MVCC 在每行记录后面都保存着两个隐藏的列，用来存储两个版本号：
- 创建版本号：指示创建一个数据行的快照时的系统版本号；
- 删除版本号：如果该快照的删除版本号大于当前事务版本号表示该快照有效，否则表示该快照已经被删除了。

#### Undo 日志
MVCC 使用到的快照存储在 Undo 日志中，该日志通过回滚指针把一个数据行（Record）的所有快照连接起来。


### 实现过程

> *以下实现过程针对可重复读隔离级别。*

当开始一个事务时，该事务的版本号肯定大于当前所有数据行快照的创建版本号，理解这一点很关键。

#### 1. select 
多个事务必须读取到同一个数据行的快照，并且这个快照是距离现在最近的一个有效快照。但是也有例外，如果有一个事务正在修改该数据行，那么它可以读取事务本身所做的修改，而不用和其它事务的读取结果一致。

把没有对一个数据行做修改的事务称为 T，T 所要读取的数据行快照的创建版本号必须小于等于 T 的版本号，因为如果大于 T 的版本号，那么表示该数据行快照是其它事务的最新修改，因此不能去读取它。除此之外，T 所要读取的数据行快照的删除版本号必须是未定义或者大于 T 的版本号，因为如果小于等于 T 的版本号，那么表示该数据行快照是已经被删除的，不应该去读取它。

#### 2. insert
将当前系统版本号作为数据行快照的创建版本号。

#### 3. delete
将当前系统版本号作为数据行快照的删除版本号。

#### 4. update
将当前系统版本号作为更新前的数据行快照的删除版本号，并将当前系统版本号作为更新后的数据行快照的创建版本号。可以理解为先执行 DELETE 后执行 INSERT。

### 快照读和当前读
在「可重复读」级别中，通过 MVCC 机制，虽然让数据变得可重复读，但我们读到的数据可能是历史数据，不是数据库当前的数据。这在一些对于数据的时效特别敏感的业务中，就很可能出问题。

对于这种读取历史数据的方式，称为快照读 (snapshot read)，而读取数据库当前版本数据的方式，称为当前读 (current read)。

#### 1. 快照读
MVCC 的 select 读取的是快照中的数据，不需要进行加锁操作。
```sql
select * from table ...;
```

#### 2. 当前读
MVCC 对数据库进行修改操作（insert、update、delete）需要进行加锁（X 锁）操作，读取的是最新的数据。
```sql
insert;
update;
delete;
```

在进行 select 操作时，也可以显式进行加锁操作。下面第一个语句需要加 S 锁，第二个需要加 X 锁。
```sql
select * from table where ? lock in share mode;
select * from table where ? for update;
```

### 参考
- [MySQL 知识点 - AobingJava](https://mp.weixin.qq.com/s/J3kCOJwyv2nzvI0_X0tlnA)