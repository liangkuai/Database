# 锁机制

## 按锁粒度：行级锁 / 表级锁 / 页级锁

#### 行级锁
行级锁是 MySQL 中加锁粒度最小的一种锁，表示只针对当前操作的记录行加锁。

行级锁发生冲突的概率最低，并发度最高，但是开销也是最大的，会出现死锁。

#### 表级锁
表级锁是 MySQL 中加锁粒度最大的一种锁，表示对当前操作的整张表加锁。

表级锁虽然实现简单，开销小，不会出现死锁，但是发生冲突的概率也最高，并发度最低。

> MySQL 中大部分存储引擎都支持表级锁，包括：InnoDB、MyISAM。

#### 页级锁
页级锁的加锁粒度介于行级锁和表级锁之间，

![锁粒度](/assets/images/锁粒度.jpg)

#### MySQL 常用存储引擎的锁机制

| 存储引擎 | 行级锁 | 页级锁 | 表级锁 |
| :--: | :--: | :--: | :--: |
| InnoDB | ✅（默认） | x | ✅ |
| MyISAM | x | x | ✅ |
| MEMORY | x | x | ✅ |
| BDB | x | ✅（默认） | ✅ |


## 按锁类型：读写锁 / 意向锁

### 读写锁
#### 共享锁（读锁，S）
如果事务 T 对数据 a 加上共享锁之后，其他事务只能对 a 加共享锁，不能加排它锁。

使用：
```sql
SELECT ... LOCK IN SHARE MODE;
```

#### 排它锁（写锁，X）
如果事务 T 对数据 a 加上排它锁之后，其他事务不能对 a 加任何类型的锁。

使用：
```sql
SELECT ... FOR UPDATE;
```


### 意向锁
意向锁是表级锁，目的主要是为了在一个事务中揭示下一行将要被请求锁的类型。

InnoDB 的两个表锁：
- 意向共享锁（IS）：表示事务准备给数据行加入共享锁，也就是说一个数据行加共享锁前必须先取得该表的 IS 锁。
- 意向排它锁（IX）表示事务准备给数据行加入排他锁，也就是说一个数据行加排他锁前必须先取得该表的 IX 锁。


> 意向锁是 InnoDB 自动加的，不需要用户显式加上。
>
> - 对于 insert、update、delete，InnoDB 会自动给涉及的数据加上排它锁；
> - 对于一般的 select，InnoDB 不会加任何锁。


### 参考
- [MySQL中的行级锁,表级锁,页级锁 - hollis](https://www.hollischuang.com/archives/914)
- [MySQL中的共享锁与排他锁 - hollis](https://www.hollischuang.com/archives/923)